# ロング動画自動生成ツール 要件定義書

**作成日**: 2025年9月26日  
**対象**: YouTube向け横型ロング動画（再生時間18〜22分を目安）

## 1. プロジェクト概要

### 1.1 目的
`shortsAI`で構築済みのショート動画自動生成パイプラインをベースに、20分前後の横型ロング動画を自動生成できるローカルツールを開発する。テキストスクリプトからシーン構成、ナレーション、BGM、サムネイルまでを一貫生成し、YouTubeへのアップロードを省力化する。

### 1.2 基本方針
- **再利用優先**: 既存モジュール（設定管理、音声合成、YouTubeアップロード等）は可能な限り流用。
- **横型・長尺最適化**: 解像度1920x1080、長尺向けのタイムライン設計、シーン遷移の自然さを重視。
- **拡張性確保**: シーンテンプレート、BGM/SE差し替え、チャプター生成など、将来的な運用拡張に備える。
- **ローカル完結**: 主処理はローカルで完了させ、外部APIはオプション扱い（例：画像生成）。

## 2. 動画仕様
- **解像度**: 1920px × 1080px（16:9 横型）
- **フレームレート**: 30fps（可変対応を検討）
- **再生時間**: 18〜22分（セクション毎に±10%調整可能）
- **フォーマット**: MP4 (H.264 / AAC)
- **音声**: ステレオ 48kHz / 24bit、ナレーション＋BGM＋SEをミックス
- **サムネイル**: 1280×720 PNG/JPEG、専用モジュールで自動生成

### 2.1 ビジュアルレイアウト方針
- **オープニング (ページ1)**: `visual_img/IMG_2901.PNG` と同等の真っ黒背景 (#000000) に白文字 (#FFFFFF)のみを中央表示。BGMは抑え目にし、ナレーション音声と同期させて差し替えタイミングを決定する。
- **本編 (ページ2以降)**: `visual_img/IMG_2902.PNG` のようなPollinations生成の16:9画像を使用。テキストは画面下部に帯状のセーフエリアを設けて配置し、読みやすさを確保。
- **画像持続時間**: 各Pollinations画像は該当ナレーションの長さに合わせて維持し（目安は約60秒前後）、その間テキストオーバーレイのみを更新。必要に応じて字幕風の行送りで段落を切り替える。
- **Ken Burns効果**: 本編画像にはズーム比1.02〜1.05程度の緩やかなKen Burns (パン／ズーム) を適用し、静止画の単調さを回避。開始位置と終了位置はタイムライン定義で指定可能にする。
- **テキスト配色**: 本編の本文は白系 (#FFFFFF) をベースに、強調語にアクセントカラー (#FF4B2Bなど) を使用。背景帯は半透明ブラックを基本とし、1ページ目は帯なしのフラット表示とする。

### 2.2 サムネイルデザイン要件
- `visual_img/sum_img1.jpg` や `sum_img2.jpg` の構成を踏襲し、上部を黒背景 (#000000) に白文字の太字タイトルを配置。
- タイトル文字数は8〜12文字程度を上限とし、フォントは ExtraBold 系を使用。
- 下部は生成画像を全面に配置し、タイトル帯との間に5〜10px 程度のセーフティマージンを確保。
- 右下に表示されている秒数などのキャプションは参考画像上のものなので再現不要。
- 必要に応じてサブテキストを追加する場合は黒帯の下部に小さめの白文字で配置する。

## 3. モジュールの再利用・改修・追加

### 3.1 そのまま再利用する要素
- **設定管理**: `config.yaml`によるAPIキー・出力設定（構造拡張のみ）。
- **音声合成**: `voice_synthesizer.py`のVOICEVOX連携（長尺向けに分割処理を追加予定）。
- **YouTubeアップローダー**: `youtube_uploader.py`（Shorts判定ロジックを通常動画向けに調整）。
- **共通ユーティリティ**: ログ設定、ディレクトリ管理、進行ログの基本実装。

### 3.2 改修が必要な要素
- **メインエントリーポイント (`main.py`)**: ページ単位処理からシーケンス/セクション単位のタイムライン処理へ改修。長尺レンダリングのリトライ制御を追加。
- **画像生成 (`image_generator.py`)**: 横型構図に最適化。Bロール用のプリセット管理、キャッシュ機構を追加。
- **動画生成器 (`video_generator.py`)**:
  - 1ページ目専用のブラックアウトテンプレート（中央白テキスト、背景帯なし）を実装。
  - 2ページ目以降は画像下部テキストレイアウトと、ナレーション長に同期するKen Burnsアニメーション（目安60秒前後）を提供。
  - 16:9レイアウトテンプレートの追加（タイトル/本文/サイドパネル等）。
  - シーン切替・トランジション（フェード、ワイプ、パン）の本実装。
  - 長尺レンダリング時のメモリ最適化（クリップ分割書き出し→連結）。
- **音声合成処理**: 長文テキストをチャンク分割し、シーン毎に話者・スピードを切り替え可能にする。
- **設定スキーマ**: シーンテンプレート、BGMリスト、サムネイル設定を追加。

### 3.3 新規追加が必要なモジュール
- **タイムラインオーケストレーター**: シーン定義（開始時刻、長さ、使用素材、テキスト、Ken Burnsパラメータ）を統合し`video_generator`に渡す。
- **チャプター&構成管理**: セクション見出しからYouTubeチャプター／目次テキストを生成。
- **サムネイル生成モジュール**: 上部黒帯＋白文字タイトルと下部生成画像を合成し、フォント・マージンを自動調整。
- **BGM/SEマネージャー**: ロングループBGMのフェード制御、シーン別SE差し込み、音量自動調整。
- **字幕・スクリプト出力機能**: SRT/WEBVTT書き出し、ナレーションとの同期。
- **メディアアセット管理**: ストック映像／画像のローカルライブラリ化と参照キャッシュ。

## 5. 入力スクリプト仕様
### 5.1 テキストスクリプト形式（`sample_txt/*.txt`）
- ファイル先頭の `s"..."` 行にサムネイル用テキストを記述する（例: `s"思考停止という病"`）。
- サムネイルタイトルは上部黒帯に配置され、自動で改行・縮小が行われる。
- `s"..."` 以降の本文が動画テキストになり、空行でページを区切る。
  - 最初のテキストブロックがページ1（黒背景＋白文字）。
  - 2つ目以降のブロックがページ2以降として、Pollinations画像と組み合わせる。
- ブロック内での改行は字幕行として扱い、VOICEVOXの読み上げ区切りにも反映する。
- サンプル: `sample_txt/sample1.txt`。


## 6. 処理フロー
1. **入力読み込み**: TXTスクリプト（`sample_txt/*.txt`形式）を解析し、セクション構造を生成。
2. **タイムライン展開**: 各ページの開始時刻、長さ、必要素材を算出。
3. **素材準備**: 
   - 画像生成（APIまたはローカル素材）: 2ページ目以降で使用するPollinations画像をセクション単位で取得しキャッシュ
   - Bロール取得／キャッシュ
   - ナレーション音声をチャンク単位で生成
   - 1ページ目のブラックスクリーンテンプレートを生成（カスタムタイトルテキスト）
4. **動画合成**: 1ページ目を黒背景で書き出し、その後は各Pollinations画像をナレーション長に合わせて維持しつつKen Burnsを適用。テキストオーバーレイはセクション進行に合わせて更新し、最後に全クリップを連結。
5. **サムネイル生成**: 代表フレーム＋テキスト飾り付け。
6. **メタデータ作成**: 章立て、概要欄テンプレート、字幕ファイルを生成。
7. **出力 & アップロード**: MP4・SRT・サムネを出力し、任意でYouTubeアップロード。

## 7. 出力物
- **動画ファイル**: `output/longform_<date>.mp4`
- **字幕**: `output/longform_<date>.srt`
- **サムネイル**: `output/thumbnail_<date>.png`（黒帯タイトル＋生成画像レイアウト）
- **ログ**: 実行ログ・エラーレポート

## 8. 技術要件
- **Python**: 3.10以上
- **主要ライブラリ**: MoviePy, Pillow, NumPy, Requests, VOICEVOX API クライアント
- **外部ツール**: FFmpeg, VOICEVOX エンジン

## 9. 品質・性能要件
- **レンダリング時間**: 20分動画をローカルGPUで30分以内、CPUのみの場合は60分以内を目標。
- **安定性**: 各セクション単位で失敗しても再実行可能なチェックポイント方式。
- **音量バランス**: LUFSメータを導入し、ナレーション基準 -16 LUFS ±1db。
- **ログ**: 進捗率、セクション名、所要時間をINFOログで出力。

## 10. 認証情報管理
- `credentials/` 配下にYouTube API関連の認証ファイルを集約し、ロング動画生成フローから参照する。
- `credentials/youtube_credentials.json` にGoogle Cloud Consoleで発行したOAuthクライアント情報を配置し、実運用時はダミー値を共有リポジトリに残す。
- `credentials/youtube_token.json` は初回認証後に自動生成されるリフレッシュトークン／アクセストークンの保存先とし、アクセス権限はローカルマシン内に限定する。
- 機密情報を扱うため、実際の認証ファイルはチーム外へ配布せず、必要な場合は`.env.example` 等でダミー設定を周知する。

